<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NFC Reader/Writer</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100">
  <div class="max-w-2xl mx-auto p-6">
    <div class="bg-white p-6 rounded-lg shadow">
      <h1 class="text-2xl font-bold mb-4">NFC Reader/Writer</h1>
      <a href="/" class="text-blue-600 hover:underline mb-4 inline-block">← Back to Tools</a>

      <div id="support-status" class="my-4"></div>

      <div id="controls">
        <h2 class="text-xl font-semibold mt-6 mb-3">Write to NFC Tag</h2>

        <div class="border border-gray-200 p-4 rounded mb-4">
          <label class="flex items-center mb-2">
            <input type="checkbox" id="encrypt-data" class="mr-2">
            <span>Use encryption key</span>
          </label>
          <input type="password" id="encryption-key" placeholder="Encryption key"
            class="w-full p-2 border border-gray-300 rounded" disabled>
        </div>

        <div class="mb-4">
          <label class="flex items-center">
            <input type="checkbox" id="use-json" class="mr-2">
            <span>Use JSON editor</span>
          </label>
        </div>

        <textarea id="write-text" rows="4" placeholder="Enter text to write to NFC tag"
          class="w-full p-2 border border-gray-300 rounded mb-3"></textarea>
        <textarea id="json-editor" class="w-full p-2 border border-gray-300 rounded mb-3 font-mono h-48"
          style="display: none;" placeholder="Enter valid JSON"></textarea>
        <div id="json-validation" class="text-red-500 text-sm mb-3"></div>

        <button id="write-button"
          class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded mb-4">
          Write to Tag
        </button>

        <h2 class="text-xl font-semibold mt-6 mb-3">Read from NFC Tag</h2>
        <button id="read-button"
          class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded mb-4">
          Read from Tag
        </button>
        <textarea id="read-text" rows="4" readonly placeholder="Tag content will appear here"
          class="w-full p-2 border border-gray-300 rounded"></textarea>
      </div>
      <div id="status" class="mt-6 p-3 rounded"></div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <script>
    const writeButton = document.getElementById('write-button');
    const readButton = document.getElementById('read-button');
    const writeText = document.getElementById('write-text');
    const readText = document.getElementById('read-text');
    const statusDiv = document.getElementById('status');
    const supportStatus = document.getElementById('support-status');
    const jsonEditor = document.getElementById('json-editor');
    const useJsonCheckbox = document.getElementById('use-json');
    const jsonValidation = document.getElementById('json-validation')
    const encryptCheckbox = document.getElementById('encrypt-data');
    const encryptionKey = document.getElementById('encryption-key');

    // Check if Web NFC is supported
    if ('NDEFReader' in window) {
      supportStatus.innerHTML = '<p class="bg-green-100 text-green-800 p-3 rounded">✓ NFC is supported on this device</p>';
    } else {
      supportStatus.innerHTML = `<p class="bg-red-100 text-red-800 p-3 rounded">
        ✕ NFC is not supported on this device. Please use Chrome for Android.
      </p>`;
      writeButton.disabled = true;
      readButton.disabled = true;
      writeButton.classList.add('opacity-50', 'cursor-not-allowed');
      readButton.classList.add('opacity-50', 'cursor-not-allowed');
    }

    function showStatus(message, type = 'info') {
      statusDiv.textContent = message;

      // Reset classes
      statusDiv.className = 'mt-6 p-3 rounded';

      // Add appropriate classes based on type
      if (type === 'success') {
        statusDiv.classList.add('bg-green-100', 'text-green-800');
      } else if (type === 'error') {
        statusDiv.classList.add('bg-red-100', 'text-red-800');
      } else {
        statusDiv.classList.add('bg-blue-100', 'text-blue-800');
      }
    }

    useJsonCheckbox.addEventListener('change', (e) => {
      writeText.style.display = e.target.checked ? 'none' : 'block';
      jsonEditor.style.display = e.target.checked ? 'block' : 'none';

      if (e.target.checked) {
        try {
          // Try to parse current text as JSON
          const currentText = writeText.value.trim();
          if (currentText) {
            const parsed = JSON.parse(currentText);
            jsonEditor.value = JSON.stringify(parsed, null, 2);
          }
        } catch {
          jsonEditor.value = '';
        }
      } else {
        try {
          writeText.value = JSON.stringify(JSON.parse(jsonEditor.value));
        } catch {
          writeText.value = jsonEditor.value;
        }
      }
    });

    // JSON validation
    jsonEditor.addEventListener('input', () => {
      try {
        const text = jsonEditor.value.trim();
        if (text) {
          JSON.parse(text);
          jsonEditor.classList.remove('border-red-500');
          jsonValidation.textContent = '';
          writeButton.disabled = false;
          writeButton.classList.remove('opacity-50', 'cursor-not-allowed');
        }
      } catch (err) {
        jsonEditor.classList.add('border-red-500');
        jsonValidation.textContent = 'Invalid JSON: ' + err.message;
        writeButton.disabled = true;
        writeButton.classList.add('opacity-50', 'cursor-not-allowed');
      }
    });

    // encryption
    encryptCheckbox.addEventListener('change', (e) => {
      encryptionKey.disabled = !e.target.checked;
      if (e.target.checked) {
        encryptionKey.classList.remove('bg-gray-100');
      } else {
        encryptionKey.classList.add('bg-gray-100');
      }
    })

    async function writeToTag() {
      let dataToWrite;

      if (useJsonCheckbox.checked) {
        try {
          dataToWrite = JSON.stringify(JSON.parse(jsonEditor.value));
        } catch (err) {
          showStatus('Invalid JSON data', 'error')
          return;
        }
      } else {
        dataToWrite = writeText.value;
      }

      if (!dataToWrite) {
        showStatus('Please enter some text to write', 'error');
        return;
      }

      // encrypt if enabled
      if (encryptCheckbox.checked && encryptionKey.value) {
        dataToWrite = CryptoJS.AES.encrypt(dataToWrite, encryptionKey.value).toString();
      }

      try {
        const ndef = new NDEFReader();
        showStatus('Tap an NFC tag to write to it...', 'info');

        await ndef.write({
          records: [{
            recordType: "text",
            data: dataToWrite
          }]
        });

        showStatus('Successfully wrote to NFC tag!', 'success');
      } catch (error) {
        console.error(error);
        showStatus(`Error: ${error.message}`, 'error');
      }
    }

    async function readFromTag() {
      try {
        const ndef = new NDEFReader();
        showStatus('Tap an NFC tag to read from it...', 'info');

        await ndef.scan();

        ndef.addEventListener("reading", ({message}) => {
          for (const record of message.records) {
            if (record.recordType === "text") {
              const textDecoder = new TextDecoder();
              let text = textDecoder.decode(record.data);

              // attempt to decrypt
              if (encryptCheckbox.checked && encryptionKey.value) {
                try {
                  const bytes = CryptoJS.AES.decrypt(text, encryptionKey.value);
                  text = bytes.toString(CryptoJS.enc.Utf8);
                } catch (err) {
                  showStatus('Failed to decrypt: invalid key or data', 'error')
                  return
                }
              }

              readText.value = text;
              showStatus('Successfully read from NFC tag!', 'success');
            }
          }
        });

      } catch (error) {
        console.error(error);
        showStatus(`Error: ${error.message}`, 'error');
      }
    }

    writeButton.addEventListener('click', writeToTag);
    readButton.addEventListener('click', readFromTag);

    // handle remote updates
    const setupSSE = () => {
      const eventSource = new EventSource('/nfc/updates');

      eventSource.onmessage = (event) => {
        const {data, format, key} = JSON.parse(event.data);

        if (format === 'json' || (!format && data.trim().startsWith('{'))) {
          // switch to JSON mode
          if (!useJsonCheckbox.checked) {
            useJsonCheckbox.checked = true;
            writeText.style.display = 'none';
            jsonEditor.style.display = 'block';
          }
          jsonEditor.value = JSON.stringify(JSON.parse(data), null, 2);
        } else {
          // switch to text mode
          if (useJsonCheckbox.checked) {
            useJsonCheckbox.checked = false;
            writeText.style.display = 'block';
            jsonEditor.style.display = 'none';
          }
          writeText.value = data;
        }

        if (key) {
          if (!encryptCheckbox.checked) {
            encryptCheckbox.checked = true
          }
          if (encryptionKey.disabled) {
            encryptionKey.disabled = false
            encryptionKey.classList.remove('bg-gray-100');
          }
          encryptionKey.value = key
        } else {
          if (encryptCheckbox.checked) {
            encryptCheckbox.checked = false
          }
          encryptionKey.value = ""
          if (!encryptionKey.disabled) {
            encryptionKey.disabled = true
            encryptionKey.classList.add('bg-gray-100');
          }
        }

        showStatus('Received remote update', 'info');
      }
    }
    setupSSE();
  </script>
</body>

</html>
